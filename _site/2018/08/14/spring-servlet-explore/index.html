<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Think-life - 思考而创作">
    <meta name="keyword"  content="曹志龙的博客, CaoZhiLong Blog, 博客, 个人网站, 云计算, docker, openstack">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>Spring揭秘--寻找遗失的web.xml - 思考生活 | ThinkLife Blog</title>

    <link rel="canonical" href="http://localhost:4000/2018/08/14/spring-servlet-explore/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">
    <link rel="stylesheet" href="/css/custom.css">


    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.bootcss.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->
	<!--
    <link rel="stylesheet" href="/css/website.css">
	-->
    <link rel="stylesheet" href="/css/mermaid.forest.min.css" media="screen">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">思考生活</a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">我的主页</a>
                    </li>
<!--                    <li>
                        <a href="/index3.html">学习笔记</a>
                    </li>-->
                    
                    <li>
                        <a href="/about/">关于</a>
                    </li>
                    
                    <li>
                        <a href="/book/">学习记录</a>
                    </li>
                    
                    <li>
                        <a href="/tags/">标签</a>
                    </li>
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/post-bg-2015.jpg" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/post-bg-2015.jpg')
    }
   /****************************自定义样式***************************/
	.sidebar-container h5 {
	    color: #808080;
	    padding-bottom: 0em;
	}
	.sidebar-container a {
	    color: #615c5c!important;
	}	
	.side-catalog .catalog-body .h3_nav, .side-catalog {
	    margin-left: 14px;
	    font-size: 12px;
	}
	.side-catalog .catalog-body .h4_nav, .side-catalog {
	    margin-left: 16px;
	    font-size: 12px;
	}	
	.side-catalog .catalog-body .h5_nav, .side-catalog {
	    margin-left: 18px;
	    font-size: 12px;
	}	
	.side-catalog .catalog-body .h6_nav, .side-catalog {
	    margin-left: 20px;
	    font-size: 12px;
	}					
	 /****************************自定义样式***************************/
    
</style>
<header class="intro-header" >
    <div class="header-mask"></div>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/tags/#Spring" title="Spring">Spring</a>
                        
                    </div>
                    <h1>Spring揭秘--寻找遗失的web.xml</h1>
                    
                    
                    <h2 class="subheading"></h2>
                    
                    <span class="meta">
                        CaoZhiLong发布于2018-08-14
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

				<h2 id="前言">前言</h2>

<p>今天我们来放松下心情，不聊分布式，云原生，来聊一聊初学者接触的最多的 java web 基础。几乎所有人都是从 servlet，jsp，filter 开始编写自己的第一个 hello world 工程。那时，还离不开 web.xml 的配置，在 xml 文件中编写繁琐的 servlet 和 filter 的配置。随着 spring 的普及，配置逐渐演变成了两种方式—java configuration 和 xml 配置共存。现如今，springboot 的普及，java configuration 成了主流，xml 配置似乎已经“灭绝”了。不知道你有没有好奇过，这中间都发生了哪些改变，web.xml 中的配置项又是被什么替代项取代了？</p>

<p><img src="http://kirito.iocoder.cn/servlet.png" alt="java" /></p>

<h2 id="servlet30-以前的时代">servlet3.0 以前的时代</h2>

<p>为了体现出整个演进过程，还是来回顾下 n 年前我们是怎么写 servlet 和 filter 代码的。</p>

<p>项目结构（本文都采用 maven 项目结构）</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># servlet2.x时代目录结构</span>
<span class="nb">.</span>
├── pom.xml
├── src
    ├── main
    │   ├── java
    │   │   └── moe
    │   │       └── cnkirito
    │   │           ├── filter
    │   │           │   └── HelloWorldFilter.java
    │   │           └── servlet
    │   │               └── HelloWorldServlet.java
    │   └── resources
    │       └── WEB-INF
    │           └── web.xml
    └── <span class="nb">test</span>
        └── java

</code></pre></div></div>
<blockquote>
  <p>HelloWorldServlet.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="nc">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="nc">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span><span class="o">,</span> <span class="nc">IOException</span> <span class="o">{</span>
        <span class="n">resp</span><span class="o">.</span><span class="na">setContentType</span><span class="o">(</span><span class="s">"text/plain"</span><span class="o">);</span>
        <span class="nc">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"hello world"</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>
<blockquote>
  <p>HelloWorldFilter.java</p>
</blockquote>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="nc">FilterConfig</span> <span class="n">filterConfig</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>

    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="nc">ServletRequest</span> <span class="n">servletRequest</span><span class="o">,</span> <span class="nc">ServletResponse</span> <span class="n">servletResponse</span><span class="o">,</span> <span class="nc">FilterChain</span> <span class="n">filterChain</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">IOException</span><span class="o">,</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"触发 hello world 过滤器..."</span><span class="o">);</span>
        <span class="n">filterChain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">servletRequest</span><span class="o">,</span><span class="n">servletResponse</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>

    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>别忘了在 web.xml 中配置 servlet 和 filter</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/javaee"</span>
           <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
           <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/javaee
        http://java.sun.com/xml/ns/javaee/web-app_4_0.xsd"</span>
           <span class="na">version=</span><span class="s">"4.0"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;servlet&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>HelloWorldServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;servlet-class&gt;</span>moe.cnkirito.servlet.HelloWorldServlet<span class="nt">&lt;/servlet-class&gt;</span>
    <span class="nt">&lt;/servlet&gt;</span>

    <span class="nt">&lt;servlet-mapping&gt;</span>
        <span class="nt">&lt;servlet-name&gt;</span>HelloWorldServlet<span class="nt">&lt;/servlet-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/hello<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/servlet-mapping&gt;</span>

    <span class="nt">&lt;filter&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>HelloWorldFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;filter-class&gt;</span>moe.cnkirito.filter.HelloWorldFilter<span class="nt">&lt;/filter-class&gt;</span>
    <span class="nt">&lt;/filter&gt;</span>
    <span class="nt">&lt;filter-mapping&gt;</span>
        <span class="nt">&lt;filter-name&gt;</span>HelloWorldFilter<span class="nt">&lt;/filter-name&gt;</span>
        <span class="nt">&lt;url-pattern&gt;</span>/hello<span class="nt">&lt;/url-pattern&gt;</span>
    <span class="nt">&lt;/filter-mapping&gt;</span>

<span class="nt">&lt;/web-app&gt;</span>

</code></pre></div></div>
<p>这样，一个 java web hello world 就完成了。当然，本文不是 servlet 的入门教程，只是为了对比。</p>

<h2 id="servlet30-新特性">servlet3.0 新特性</h2>

<p><img src="http://kirito.iocoder.cn/servlet_3.0.jpg" alt="servlet_3.0" /></p>

<p>Servlet 3.0 作为 Java EE 6 规范体系中一员，随着 Java EE 6 规范一起发布。该版本在前一版本（Servlet 2.5）的基础上提供了若干新特性用于简化 Web 应用的开发和部署。其中一项新特性便是提供了无 xml 配置的特性。</p>

<p>servlet3.0 首先提供了 @WebServlet，@WebFilter 等注解，这样便有了抛弃 web.xml 的第一个途径，凭借注解声明 servlet 和 filter 来做到这一点。</p>

<p>除了这种方式，servlet3.0 规范还提供了更强大的功能，可以在运行时动态注册 servlet ，filter，listener。以 servlet 为例，过滤器与监听器与之类似。ServletContext 为动态配置 Servlet 增加了如下方法：</p>

<ul>
  <li>ServletRegistration.Dynamic addServlet(String servletName,Class&lt;? extends Servlet&gt; servletClass)</li>
  <li>ServletRegistration.Dynamic addServlet(String servletName, Servlet servlet)</li>
  <li>ServletRegistration.Dynamic addServlet(String servletName, String className)</li>
  <li>T createServlet(Class clazz)</li>
  <li>ServletRegistration getServletRegistration(String servletName)</li>
  <li>Map&lt;String,? extends ServletRegistration&gt; getServletRegistrations()</li>
</ul>

<p>其中前三个方法的作用是相同的，只是参数类型不同而已；通过 createServlet() 方法创建的 Servlet，通常需要做一些自定义的配置，然后使用 addServlet() 方法来将其动态注册为一个可以用于服务的 Servlet。两个 getServletRegistration() 方法主要用于动态为 Servlet 增加映射信息，这等价于在 web.xml 中使用 标签为存在的 Servlet 增加映射信息。</p>

<p>以上 ServletContext 新增的方法要么是在 ServletContextListener 的 contexInitialized 方法中调用，要么是在 ServletContainerInitializer 的 onStartup() 方法中调用。</p>

<p>ServletContainerInitializer 也是 Servlet 3.0 新增的一个接口，容器在启动时使用 JAR 服务 API(JAR Service API) 来发现 ServletContainerInitializer 的实现类，并且容器将 WEB-INF/lib 目录下 JAR 包中的类都交给该类的 onStartup() 方法处理，我们通常需要在该实现类上使用 @HandlesTypes 注解来指定希望被处理的类，过滤掉不希望给 onStartup() 处理的类。</p>

<p>一个典型的 servlet3.0+ 的 web 项目结构如下：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── pom.xml
└── src
    ├── main
    │   ├── java
    │   │   └── moe
    │   │       └── cnkirito
    │   │           ├── CustomServletContainerInitializer.java
    │   │           ├── filter
    │   │           │   └── HelloWorldFilter.java
    │   │           └── servlet
    │   │               └── HelloWorldServlet.java
    │   └── resources
    │       └── META-INF
    │           └── services
    │               └── javax.servlet.ServletContainerInitializer
    └── <span class="nb">test</span>
        └── java

</code></pre></div></div>

<p>我并未对 HelloWorldServlet 和 HelloWorldFilter 做任何改动，而是新增了一个 CustomServletContainerInitializer ,它实现了 <code class="highlighter-rouge">java javax.servlet.ServletContainerInitializer</code> 接口，用来在 web 容器启动时加载指定的 servlet 和 filter，代码如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomServletContainerInitializer</span> <span class="kd">implements</span> <span class="nc">ServletContainerInitializer</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">JAR_HELLO_URL</span> <span class="o">=</span> <span class="s">"/hello"</span><span class="o">;</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">c</span><span class="o">,</span> <span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="o">{</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"创建 helloWorldServlet..."</span><span class="o">);</span>

    <span class="nc">ServletRegistration</span><span class="o">.</span><span class="na">Dynamic</span> <span class="n">servlet</span> <span class="o">=</span> <span class="n">servletContext</span><span class="o">.</span><span class="na">addServlet</span><span class="o">(</span>
            <span class="nc">HelloWorldServlet</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
            <span class="nc">HelloWorldServlet</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">servlet</span><span class="o">.</span><span class="na">addMapping</span><span class="o">(</span><span class="no">JAR_HELLO_URL</span><span class="o">);</span>

    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"创建 helloWorldFilter..."</span><span class="o">);</span>

    <span class="nc">FilterRegistration</span><span class="o">.</span><span class="na">Dynamic</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">servletContext</span><span class="o">.</span><span class="na">addFilter</span><span class="o">(</span>
            <span class="nc">HelloWorldFilter</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="nc">HelloWorldFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="nc">EnumSet</span><span class="o">&lt;</span><span class="nc">DispatcherType</span><span class="o">&gt;</span> <span class="n">dispatcherTypes</span> <span class="o">=</span> <span class="nc">EnumSet</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="nc">DispatcherType</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">dispatcherTypes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">DispatcherType</span><span class="o">.</span><span class="na">REQUEST</span><span class="o">);</span> 
    <span class="n">dispatcherTypes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">DispatcherType</span><span class="o">.</span><span class="na">FORWARD</span><span class="o">);</span> 

    <span class="n">filter</span><span class="o">.</span><span class="na">addMappingForUrlPatterns</span><span class="o">(</span><span class="n">dispatcherTypes</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="no">JAR_HELLO_URL</span><span class="o">);</span>

  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>对上述代码进行一些解读。ServletContext 我们称之为 servlet 上下文，它维护了整个 web 容器中注册的 servlet，filter，listener，以 servlet 为例，可以使用 servletContext.addServlet 等方法来添加 servlet。而方法入参中 Set&lt;Class<?>> c 和 @HandlesTypes 注解在 demo 中我并未使用，感兴趣的朋友可以 debug 看看到底获取了哪些 class ，一般正常的流程是使用 @HandlesTypes 指定需要处理的 class，而后对 Set<Class<?>&gt; 进行判断是否属于该 class，正如前文所言，onStartup 会加载不需要被处理的一些 class。</p>

<p>这么声明一个 ServletContainerInitializer 的实现类，web 容器并不会识别它，所以，需要借助 SPI 机制来指定该初始化类，这一步骤是通过在项目路径下创建 <code class="highlighter-rouge">shell META-INF/services/javax.servlet.ServletContainerInitializer</code> 来做到的，它只包含一行内容：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>moe.cnkirito.CustomServletContainerInitializer
</code></pre></div></div>

<p>使用 ServletContainerInitializer 和 SPI 机制，我们的 web 应用便可以彻底摆脱 web.xml 了。</p>

<h2 id="spring-是如何支持-servlet30-的">Spring 是如何支持 servlet3.0 的？</h2>

<p>回到我们的 spring 全家桶，可能已经忘了具体是什么时候开始不写 web.xml 了，我只知道现在的项目已经再也看不到它了，spring 又是如何支持 servlet3.0 规范的呢？</p>

<p>寻找 spring 中 ServletContainerInitializer 的实现类并不困难，可以迅速定位到 SpringServletContainerInitializer 该实现类。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@HandlesTypes</span><span class="o">(</span><span class="nc">WebApplicationInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringServletContainerInitializer</span> <span class="kd">implements</span> <span class="nc">ServletContainerInitializer</span> <span class="o">{</span>
    <span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">webAppInitializerClasses</span><span class="o">,</span> <span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span>
			<span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>

		<span class="nc">List</span><span class="o">&lt;</span><span class="nc">WebApplicationInitializer</span><span class="o">&gt;</span> <span class="n">initializers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedList</span><span class="o">&lt;</span><span class="nc">WebApplicationInitializer</span><span class="o">&gt;();</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">webAppInitializerClasses</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">for</span> <span class="o">(</span><span class="nc">Class</span><span class="o">&lt;?&gt;</span> <span class="n">waiClass</span> <span class="o">:</span> <span class="n">webAppInitializerClasses</span><span class="o">)</span> <span class="o">{</span>
				<span class="c1">// Be defensive: Some servlet containers provide us with invalid classes,</span>
				<span class="c1">// no matter what @HandlesTypes says...</span>
                <span class="c1">// &lt;1&gt;</span>
				<span class="k">if</span> <span class="o">(!</span><span class="n">waiClass</span><span class="o">.</span><span class="na">isInterface</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nc">Modifier</span><span class="o">.</span><span class="na">isAbstract</span><span class="o">(</span><span class="n">waiClass</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">())</span> <span class="o">&amp;&amp;</span>
						<span class="nc">WebApplicationInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">isAssignableFrom</span><span class="o">(</span><span class="n">waiClass</span><span class="o">))</span> <span class="o">{</span>
					<span class="k">try</span> <span class="o">{</span>
						<span class="n">initializers</span><span class="o">.</span><span class="na">add</span><span class="o">((</span><span class="nc">WebApplicationInitializer</span><span class="o">)</span> <span class="n">waiClass</span><span class="o">.</span><span class="na">newInstance</span><span class="o">());</span>
					<span class="o">}</span>
					<span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
						<span class="k">throw</span> <span class="k">new</span> <span class="nf">ServletException</span><span class="o">(</span><span class="s">"Failed to instantiate WebApplicationInitializer class"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
					<span class="o">}</span>
				<span class="o">}</span>
			<span class="o">}</span>
		<span class="o">}</span>

		<span class="k">if</span> <span class="o">(</span><span class="n">initializers</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">{</span>
			<span class="n">servletContext</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="s">"No Spring WebApplicationInitializer types detected on classpath"</span><span class="o">);</span>
			<span class="k">return</span><span class="o">;</span>
		<span class="o">}</span>

		<span class="n">servletContext</span><span class="o">.</span><span class="na">log</span><span class="o">(</span><span class="n">initializers</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">" Spring WebApplicationInitializers detected on classpath"</span><span class="o">);</span>
		<span class="nc">AnnotationAwareOrderComparator</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">initializers</span><span class="o">);</span>
        <span class="c1">// &lt;2&gt;</span>
		<span class="k">for</span> <span class="o">(</span><span class="nc">WebApplicationInitializer</span> <span class="n">initializer</span> <span class="o">:</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
			<span class="n">initializer</span><span class="o">.</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>查看其 java doc，描述如下：</p>

<blockquote>
  <p>Servlet 3.0 {@link ServletContainerInitializer} designed to support code-based configuration of the servlet container using Spring’s {@link WebApplicationInitializer} SPI as opposed to (or possibly in combination with) the traditional {@code web.xml}-based approach.</p>
</blockquote>

<p>注意我在源码中标注两个序号，这对于我们理解 spring 装配 servlet 的流程来说非常重要。</p>

<p>&lt;1&gt; 英文注释是 spring 源码中自带的，它提示我们由于 servlet 厂商实现的差异，onStartup 方法会加载我们本不想处理的 class，所以进行了特判。</p>

<p>&lt;2&gt; spring 与我们之前的 demo 不同，并没有在 SpringServletContainerInitializer 中直接对 servlet 和 filter 进行注册，而是委托给了一个陌生的类 WebApplicationInitializer ，WebApplicationInitializer 类便是 spring 用来初始化 web 环境的委托者类，它通常有三个实现类：</p>

<p><img src="http://kirito.iocoder.cn/WebApplicationInitializer.png" alt="WebApplicationInitializer" /></p>

<p>你一定不会对 dispatcherServlet 感到陌生，AbstractDispatcherServletInitializer#registerDispatcherServlet 便是无 web.xml 前提下创建 dispatcherServlet 的关键代码。</p>

<p>可以去项目中寻找一下 org.springframework:spring-web:version 的依赖，它下面就存在一个 servletContainerInitializer 的扩展，指向了 SpringServletContainerInitializer，这样只要在 servlet3.0 环境下部署，spring 便可以自动加载进行初始化：</p>

<p><img src="http://kirito.iocoder.cn/F835D518-A725-40D9-84BA-6AC014DAE5A7.png" alt="SpringServletContainerInitializer" /></p>

<p>注意，上述这一切特性从 spring 3 就已经存在了，而如今 spring 5 已经伴随 springboot 2.0 一起发行了。</p>

<h2 id="springboot-如何加载-servlet">SpringBoot 如何加载 Servlet？</h2>

<p>读到这儿，你已经阅读了全文的 1/2。springboot 对于 servlet 的处理才是重头戏，其一，是因为 springboot 使用范围很广，很少有人用 spring 而不用 springboot 了；其二，是因为它没有完全遵守 servlet3.0 的规范！</p>

<p>是的，前面所讲述的 servlet 的规范，无论是 web.xml 中的配置，还是 servlet3.0 中的 ServletContainerInitializer 和 springboot 的加载流程都没有太大的关联。按照惯例，先卖个关子，先看看如何在 springboot 中注册 servlet 和 filter，再来解释下 springboot 的独特之处。</p>

<h3 id="注册方式一servlet30注解servletcomponentscan">注册方式一：servlet3.0注解+@ServletComponentScan</h3>
<p>springboot 依旧兼容 servlet3.0 一系列以 @Web* 开头的注解：@WebServlet，@WebFilter，@WebListener</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebServlet</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldServlet</span> <span class="kd">extends</span> <span class="nc">HttpServlet</span><span class="o">{}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@WebFilter</span><span class="o">(</span><span class="s">"/hello/*"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorldFilter</span> <span class="kd">implements</span> <span class="nc">Filter</span> <span class="o">{}</span>
</code></pre></div></div>

<p>不要忘记让启动类去扫描到这些注解</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@SpringBootApplication</span>
<span class="nd">@ServletComponentScan</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringBootServletApplication</span> <span class="o">{</span>

   <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">SpringBootServletApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>

<p>我认为这是几种方式中最为简洁的方式，如果真的有特殊需求，需要在 springboot 下注册 servlet，filter，可以采用这样的方式，比较直观。</p>

<h3 id="注册方式二registrationbean">注册方式二：RegistrationBean</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">ServletRegistrationBean</span> <span class="nf">helloWorldServlet</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">ServletRegistrationBean</span> <span class="n">helloWorldServlet</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ServletRegistrationBean</span><span class="o">();</span>
    <span class="n">myServlet</span><span class="o">.</span><span class="na">addUrlMappings</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">);</span>
    <span class="n">myServlet</span><span class="o">.</span><span class="na">setServlet</span><span class="o">(</span><span class="k">new</span> <span class="nc">HelloWorldServlet</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">helloWorldServlet</span><span class="o">;</span>
<span class="o">}</span>

<span class="nd">@Bean</span>
<span class="kd">public</span> <span class="nc">FilterRegistrationBean</span> <span class="nf">helloWorldFilter</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">FilterRegistrationBean</span> <span class="n">helloWorldFilter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FilterRegistrationBean</span><span class="o">();</span>
    <span class="n">myFilter</span><span class="o">.</span><span class="na">addUrlPatterns</span><span class="o">(</span><span class="s">"/hello/*"</span><span class="o">);</span>
    <span class="n">myFilter</span><span class="o">.</span><span class="na">setFilter</span><span class="o">(</span><span class="k">new</span> <span class="nc">HelloWorldFilter</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">helloWorldFilter</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>ServletRegistrationBean 和 FilterRegistrationBean 都集成自 RegistrationBean ，RegistrationBean 是 springboot 中广泛应用的一个注册类，负责把 servlet，filter，listener 给容器化，使他们被 spring 托管，并且完成自身对 web 容器的注册。这种注册方式也值得推崇。</p>

<p><img src="http://kirito.iocoder.cn/RegistrationBean.png" alt="RegistrationBean" /></p>

<p>从图中可以看出 RegistrationBean 的地位，它的几个实现类作用分别是：帮助容器注册 filter，servlet，listener，最后的 DelegatingFilterProxyRegistrationBean 使用的不多，但熟悉 SpringSecurity 的朋友不会感到陌生，SpringSecurityFilterChain 就是通过这个代理类来调用的。另外 RegistrationBean 实现了 ServletContextInitializer 接口，这个接口将会是下面分析的核心接口，大家先混个眼熟，了解下它有一个抽象实现 RegistrationBean 即可。</p>

<h2 id="springboot中servlet加载流程的源码分析">SpringBoot中servlet加载流程的源码分析</h2>

<p>暂时只介绍这两种方式，下面解释下之前卖的关子，为什么说 springboot 没有完全遵守 servlet3.0 规范。讨论的前提是 springboot 环境下使用内嵌的容器，比如最典型的 tomcat。高能预警，以下内容比较烧脑，觉得看起来吃力的朋友可以跳过本节直接看下一节的总结！</p>

<h3 id="initializer被替换为tomcatstarter">Initializer被替换为TomcatStarter</h3>

<p>当使用内嵌的 tomcat 时，你会发现 springboot 完全走了另一套初始化流程，完全没有使用前面提到的 SpringServletContainerInitializer，实际上一开始我在各种 ServletContainerInitializer 的实现类中打了断点，最终定位到，根本没有运行到 SpringServletContainerInitializer 内部，而是进入了 TomcatStarter 这个类中。</p>

<p><img src="http://kirito.iocoder.cn/TomcatStarter.png" alt="TomcatStarter" /></p>

<p>并且，仔细扫了一眼源码的包，并没有发现有 SPI 文件对应到 TomcatStarter。于是我猜想，内嵌 tomcat 的加载可能不依赖于 servlet3.0 规范和 SPI！它完全走了一套独立的逻辑。为了验证这一点，我翻阅了 spring github 中的 issue，得到了 spring 作者肯定的答复：https://github.com/spring-projects/spring-boot/issues/321</p>

<blockquote>
  <p>This was actually an intentional design decision. The search algorithm used by the containers was problematic. It also causes problems when you want to develop an executable WAR as you often want a javax.servlet.ServletContainerInitializer for the WAR that is not executed when you run java -jar. <br />
See the org.springframework.boot.context.embedded.ServletContextInitializer for an option that works with Spring Beans.</p>
</blockquote>

<p>pringboot 这么做是有意而为之。springboot 考虑到了如下的问题，我们在使用 springboot 时，开发阶段一般都是使用内嵌 tomcat 容器，但部署时却存在两种选择：一种是打成 jar 包，使用 java -jar 的方式运行；另一种是打成 war 包，交给外置容器去运行。前者就会导致容器搜索算法出现问题，因为这是 jar 包的运行策略，不会按照 servlet3.0 的策略去加载 ServletContainerInitializer！最后作者还提供了一个替代选项：ServletContextInitializer，注意是 ServletContextInitializer！它和 ServletContainerInitializer 长得特别像，别搞混淆了，前者 ServletContextInitializer 是 org.springframework.boot.web.servlet.ServletContextInitializer，后者 ServletContainerInitializer 是 javax.servlet.ServletContainerInitializer，前文还提到 RegistrationBean 实现了 ServletContextInitializer 接口。</p>

<h3 id="tomcatstarter中的servletcontextinitializer是关键">TomcatStarter中的ServletContextInitializer是关键</h3>

<p>TomcatStarter 中的 org.springframework.boot.context.embedded.ServletContextInitializer 是 springboot 初始化 servlet，filter，listener 的关键。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TomcatStarter</span> <span class="kd">implements</span> <span class="nc">ServletContainerInitializer</span> <span class="o">{</span>

   <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">;</span>

   <span class="nc">TomcatStarter</span><span class="o">(</span><span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">this</span><span class="o">.</span><span class="na">initializers</span> <span class="o">=</span> <span class="n">initializers</span><span class="o">;</span>
   <span class="o">}</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">Set</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">classes</span><span class="o">,</span> <span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span>
         <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
         <span class="k">for</span> <span class="o">(</span><span class="nc">ServletContextInitializer</span> <span class="n">initializer</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">initializers</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">initializer</span><span class="o">.</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
         <span class="o">}</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>经过删减源码后，可以看出 TomcatStarter 的主要逻辑，它其实就是负责调用一系列 ServletContextInitializer 的 onStartup 方法，那么在 debug 中，ServletContextInitializer[] initializers 到底包含了哪些类呢？会不会有我们前面介绍的 RegisterBean 呢？</p>

<p><img src="http://kirito.iocoder.cn/35560726-DD9D-478A-BFCA-12ACF4DB497D.png" alt="initializers" /></p>

<p>太天真了，RegisterBean 并没有出现在 TomcatStarter 的 debug 信息中，initializers 只包含了三个类，其中只有第一个类看上去比较核心，注意第一个类不是 EmbeddedWebApplicationContext！而是这个类中的 $1 匿名类，为了搞清楚 springboot 如何加载 filter servlet listener ，看来还得研究下 EmbeddedWebApplicationContext 的结构。</p>

<h2 id="embeddedwebapplicationcontext中的6层迭代加载">EmbeddedWebApplicationContext中的6层迭代加载</h2>

<p>ApplicationContext 大家应该是比较熟悉的，这是 spring 一个比较核心的类，一般我们可以从中获取到那些注册在容器中的托管 Bean，而这篇文章，主要分析的便是它在内嵌容器中的实现类：EmbeddedWebApplicationContext，重点分析它加载 filter servlet listener 这部分的代码。这里是整个代码中迭代层次最深的部分，做好心理准备起航，来看看 EmbeddedWebApplicationContext 是怎么获取到所有的 servlet filter listener 的！以下方法均出自于 EmbeddedWebApplicationContext。</p>

<h3 id="第一层onrefresh">第一层：onRefresh()</h3>

<p>onRefresh 是 ApplicationContext 的生命周期方法，EmbeddedWebApplicationContext 的实现非常简单，只干了一件事：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Override</span>
<span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onRefresh</span><span class="o">()</span> <span class="o">{</span>
   <span class="kd">super</span><span class="o">.</span><span class="na">onRefresh</span><span class="o">();</span>
   <span class="k">try</span> <span class="o">{</span>
      <span class="n">createEmbeddedServletContainer</span><span class="o">();</span><span class="c1">//第二层的入口</span>
   <span class="o">}</span>
   <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"Unable to start embedded container"</span><span class="o">,</span>
            <span class="n">ex</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>createEmbeddedServletContainer 连接到了第二层</p>

<h3 id="第二层createembeddedservletcontainer">第二层：createEmbeddedServletContainer()</h3>

<p>看名字 spring 是想创建一个内嵌的 servlet 容器，ServletContainer 其实就是 servlet filter listener 的总称。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">createEmbeddedServletContainer</span><span class="o">()</span> <span class="o">{</span>
   <span class="nc">EmbeddedServletContainer</span> <span class="n">localContainer</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">embeddedServletContainer</span><span class="o">;</span>
   <span class="nc">ServletContext</span> <span class="n">localServletContext</span> <span class="o">=</span> <span class="n">getServletContext</span><span class="o">();</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">localContainer</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">localServletContext</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="nc">EmbeddedServletContainerFactory</span> <span class="n">containerFactory</span> <span class="o">=</span> <span class="n">getEmbeddedServletContainerFactory</span><span class="o">();</span>
      <span class="k">this</span><span class="o">.</span><span class="na">embeddedServletContainer</span> <span class="o">=</span> <span class="n">containerFactory</span>
            <span class="o">.</span><span class="na">getEmbeddedServletContainer</span><span class="o">(</span><span class="n">getSelfInitializer</span><span class="o">());</span><span class="c1">//第三层的入口</span>
   <span class="o">}</span>
   <span class="k">else</span> <span class="nf">if</span> <span class="o">(</span><span class="n">localServletContext</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">try</span> <span class="o">{</span>
         <span class="n">getSelfInitializer</span><span class="o">().</span><span class="na">onStartup</span><span class="o">(</span><span class="n">localServletContext</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">catch</span> <span class="o">(</span><span class="nc">ServletException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">throw</span> <span class="k">new</span> <span class="nf">ApplicationContextException</span><span class="o">(</span><span class="s">"Cannot initialize servlet context"</span><span class="o">,</span>
               <span class="n">ex</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">}</span>
   <span class="n">initPropertySources</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>凡是带有 servlet，initializer 字样的方法都是我们需要留意的，getSelfInitializer() 便涉及到了我们最为关心的初始化流程。</p>

<h3 id="第三层getselfinitializer">第三层：getSelfInitializer()</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="n">org</span><span class="o">.</span><span class="na">springframework</span><span class="o">.</span><span class="na">boot</span><span class="o">.</span><span class="na">web</span><span class="o">.</span><span class="na">servlet</span><span class="o">.</span><span class="na">ServletContextInitializer</span> <span class="nf">getSelfInitializer</span><span class="o">()</span> <span class="o">{</span>
   <span class="k">return</span> <span class="k">new</span> <span class="nf">ServletContextInitializer</span><span class="o">()</span> <span class="o">{</span>
      <span class="nd">@Override</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
         <span class="n">selfInitialize</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
      <span class="o">}</span>
   <span class="o">};</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">selfInitialize</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
   <span class="n">prepareEmbeddedWebApplicationContext</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
   <span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span> <span class="o">=</span> <span class="n">getBeanFactory</span><span class="o">();</span>
   <span class="nc">ExistingWebApplicationScopes</span> <span class="n">existingScopes</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ExistingWebApplicationScopes</span><span class="o">(</span>
         <span class="n">beanFactory</span><span class="o">);</span>
   <span class="nc">WebApplicationContextUtils</span><span class="o">.</span><span class="na">registerWebApplicationScopes</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span>
         <span class="n">getServletContext</span><span class="o">());</span>
   <span class="n">existingScopes</span><span class="o">.</span><span class="na">restore</span><span class="o">();</span>
   <span class="nc">WebApplicationContextUtils</span><span class="o">.</span><span class="na">registerEnvironmentBeans</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">,</span>
         <span class="n">getServletContext</span><span class="o">());</span>
   <span class="c1">//第四层的入口</span>
   <span class="k">for</span> <span class="o">(</span><span class="nc">ServletContextInitializer</span> <span class="n">beans</span> <span class="o">:</span> <span class="n">getServletContextInitializerBeans</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">beans</span><span class="o">.</span><span class="na">onStartup</span><span class="o">(</span><span class="n">servletContext</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>还记得前面 TomcatStarter 的 debug 信息中，第一个 ServletContextInitializer 就是出现在 EmbeddedWebApplicationContext 中的一个匿名类，没错了，就是这里的 getSelfInitializer() 方法创建的！解释下这里的 getSelfInitializer() 和 selfInitialize(ServletContext servletContext) 为什么要这么设计：这是典型的回调式方式，当匿名 ServletContextInitializer 类被 TomcatStarter 的 onStartup 方法调用，设计上是触发了 selfInitialize(ServletContext servletContext) 的调用。所以这下就清晰了，为什么 TomcatStarter 中没有出现 RegisterBean ，其实是隐式触发了 EmbeddedWebApplicationContext 中的 selfInitialize 方法。selfInitialize 方法中的 getServletContextInitializerBeans() 成了关键。</p>

<h3 id="第四层getservletcontextinitializerbeans">第四层：getServletContextInitializerBeans()</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * Returns {@link ServletContextInitializer}s that should be used with the embedded
 * Servlet context. By default this method will first attempt to find
 * {@link ServletContextInitializer}, {@link Servlet}, {@link Filter} and certain
 * {@link EventListener} beans.
 * @return the servlet initializer beans
 */</span>
<span class="kd">protected</span> <span class="nc">Collection</span><span class="o">&lt;</span><span class="nc">ServletContextInitializer</span><span class="o">&gt;</span> <span class="nf">getServletContextInitializerBeans</span><span class="o">()</span> <span class="o">{</span>
   <span class="k">return</span> <span class="k">new</span> <span class="nf">ServletContextInitializerBeans</span><span class="o">(</span><span class="n">getBeanFactory</span><span class="o">());</span><span class="c1">//第五层的入口</span>
<span class="o">}</span>
</code></pre></div></div>

<p>没错了，注释都告诉我们，这个 ServletContextInitializerBeans 是用来加载 Servlet 和 Filter 的。</p>

<h3 id="第五层servletcontextinitializerbeans的构造方法">第五层：ServletContextInitializerBeans的构造方法</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nf">ServletContextInitializerBeans</span><span class="o">(</span><span class="nc">ListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">this</span><span class="o">.</span><span class="na">initializers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">LinkedMultiValueMap</span><span class="o">&lt;</span><span class="nc">Class</span><span class="o">&lt;?&gt;,</span> <span class="nc">ServletContextInitializer</span><span class="o">&gt;();</span>
   <span class="n">addServletContextInitializerBeans</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span><span class="c1">// 第六层的入口</span>
   <span class="n">addAdaptableBeans</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
   <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ServletContextInitializer</span><span class="o">&gt;</span> <span class="n">sortedInitializers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ArrayList</span><span class="o">&lt;</span><span class="nc">ServletContextInitializer</span><span class="o">&gt;();</span>
   <span class="k">for</span> <span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;?,</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">ServletContextInitializer</span><span class="o">&gt;&gt;</span> <span class="n">entry</span> <span class="o">:</span> <span class="k">this</span><span class="o">.</span><span class="na">initializers</span>
         <span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
      <span class="nc">AnnotationAwareOrderComparator</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
      <span class="n">sortedInitializers</span><span class="o">.</span><span class="na">addAll</span><span class="o">(</span><span class="n">entry</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
   <span class="o">}</span>
   <span class="k">this</span><span class="o">.</span><span class="na">sortedList</span> <span class="o">=</span> <span class="nc">Collections</span><span class="o">.</span><span class="na">unmodifiableList</span><span class="o">(</span><span class="n">sortedInitializers</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="第六层addservletcontextinitializerbeansbeanfactory">第六层：addServletContextInitializerBeans(beanFactory)</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kt">void</span> <span class="nf">addServletContextInitializerBeans</span><span class="o">(</span><span class="nc">ListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="o">{</span>
   <span class="k">for</span> <span class="o">(</span><span class="nc">Entry</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">ServletContextInitializer</span><span class="o">&gt;</span> <span class="n">initializerBean</span> <span class="o">:</span> <span class="n">getOrderedBeansOfType</span><span class="o">(</span>
         <span class="n">beanFactory</span><span class="o">,</span> <span class="nc">ServletContextInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">addServletContextInitializerBean</span><span class="o">(</span><span class="n">initializerBean</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span>
            <span class="n">initializerBean</span><span class="o">.</span><span class="na">getValue</span><span class="o">(),</span> <span class="n">beanFactory</span><span class="o">);</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>getOrderedBeansOfType 方法便是去容器中寻找注册过得 ServletContextInitializer ，这时候就可以把之前那些 RegisterBean 全部加载出来了，并且 RegisterBean 还实现了 Ordered 接口，在这儿用于排序。不再往下迭代了。</p>

<h2 id="embeddedwebapplicationcontext加载流程总结">EmbeddedWebApplicationContext加载流程总结</h2>

<p>如果你对具体的代码流程不感兴趣，可以跳过上述的6层分析，直接看本节的结论。总结如下：</p>

<ul>
  <li>EmbeddedWebApplicationContext 的 onRefresh 方法触发配置了一个匿名的 ServletContextInitializer。</li>
  <li>这个匿名的 ServletContextInitializer 的 onStartup 方法会去容器中搜索到了所有的 RegisterBean 并按照顺序加载到 ServletContext 中。</li>
  <li>这个匿名的 ServletContextInitializer 最终传递给 TomcatStarter，由 TomcatStarter 的 onStartup 方法去触发 ServletContextInitializer 的 onStartup 方法，最终完成装配！</li>
</ul>

<p><img src="http://kirito.iocoder.cn/8FFCA673-DB72-4C0A-BDE9-58CB4B80C484.png" alt="getServletContextInitializerBeans" /></p>

<h2 id="第三种注册-servlet-的方式">第三种注册 Servlet 的方式</h2>

<p>研究完了上述 springboot 启动的内部原理，可以发现 ServletContextInitializer 其实是 spring 中 ServletContainerInitializer 的代理，虽然 springboot 中 Servlet3.0 不起作用了，但它的代理还是会被加载的，于是我们有了第三种方式注册 servlet。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomServletContextInitializer</span> <span class="kd">implements</span> <span class="nc">ServletContextInitializer</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="kd">static</span> <span class="nc">String</span> <span class="no">JAR_HELLO_URL</span> <span class="o">=</span> <span class="s">"/hello"</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onStartup</span><span class="o">(</span><span class="nc">ServletContext</span> <span class="n">servletContext</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">ServletException</span> <span class="o">{</span>
        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"创建 helloWorldServlet..."</span><span class="o">);</span>

        <span class="nc">ServletRegistration</span><span class="o">.</span><span class="na">Dynamic</span> <span class="n">servlet</span> <span class="o">=</span> <span class="n">servletContext</span><span class="o">.</span><span class="na">addServlet</span><span class="o">(</span>
                <span class="nc">HelloWorldServlet</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span>
                <span class="nc">HelloWorldServlet</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">servlet</span><span class="o">.</span><span class="na">addMapping</span><span class="o">(</span><span class="no">JAR_HELLO_URL</span><span class="o">);</span>

        <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"创建 helloWorldFilter..."</span><span class="o">);</span>

        <span class="nc">FilterRegistration</span><span class="o">.</span><span class="na">Dynamic</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">servletContext</span><span class="o">.</span><span class="na">addFilter</span><span class="o">(</span>
                <span class="nc">HelloWorldFilter</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getSimpleName</span><span class="o">(),</span> <span class="nc">HelloWorldFilter</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="nc">EnumSet</span><span class="o">&lt;</span><span class="nc">DispatcherType</span><span class="o">&gt;</span> <span class="n">dispatcherTypes</span> <span class="o">=</span> <span class="nc">EnumSet</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="nc">DispatcherType</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">dispatcherTypes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">DispatcherType</span><span class="o">.</span><span class="na">REQUEST</span><span class="o">);</span>
        <span class="n">dispatcherTypes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="nc">DispatcherType</span><span class="o">.</span><span class="na">FORWARD</span><span class="o">);</span>

        <span class="n">filter</span><span class="o">.</span><span class="na">addMappingForUrlPatterns</span><span class="o">(</span><span class="n">dispatcherTypes</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="no">JAR_HELLO_URL</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>虽然 ServletCantainerInitializer 不能被内嵌容器加载，ServletContextInitializer 却能被 springboot 的 EmbeddedWebApplicationContext 加载到，从而装配其中的 servlet 和 filter。实际开发中，还是以一，二两种方法来注册为主，这里只是提供一个可能性，来让我们理解 springboot 的加载流程。</p>

<blockquote>
  <p>更新至 19年1月</p>
</blockquote>

<h2 id="加载流程拾遗">加载流程拾遗</h2>

<h3 id="tomcatstarter-既然不是通过-spi-机制装配的那是怎么被-spring-使用的">TomcatStarter 既然不是通过 SPI 机制装配的，那是怎么被 spring 使用的？</h3>

<p>自然是被 new 出来的，在 TomcatEmbeddedServletContainerFactory#configureContext 中可以看到，TomcatStarter 是被主动实例化出来的，并且还传入了 ServletContextInitializer 的数组，和上面分析的一样，一共有三个 ServletContextInitializer，包含了 EmbeddedWebApplicationContext 中的匿名实现。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">protected</span> <span class="kt">void</span> <span class="nf">configureContext</span><span class="o">(</span><span class="nc">Context</span> <span class="n">context</span><span class="o">,</span>
      <span class="nc">ServletContextInitializer</span><span class="o">[]</span> <span class="n">initializers</span><span class="o">)</span> <span class="o">{</span>
   <span class="nc">TomcatStarter</span> <span class="n">starter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">TomcatStarter</span><span class="o">(</span><span class="n">initializers</span><span class="o">);</span>
   <span class="k">if</span> <span class="o">(</span><span class="n">context</span> <span class="k">instanceof</span> <span class="nc">TomcatEmbeddedContext</span><span class="o">)</span> <span class="o">{</span>
      <span class="c1">// Should be true</span>
      <span class="o">((</span><span class="nc">TomcatEmbeddedContext</span><span class="o">)</span> <span class="n">context</span><span class="o">).</span><span class="na">setStarter</span><span class="o">(</span><span class="n">starter</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="n">context</span><span class="o">.</span><span class="na">addServletContainerInitializer</span><span class="o">(</span><span class="n">starter</span><span class="o">,</span> <span class="no">NO_CLASSES</span><span class="o">);</span>
   <span class="o">...</span>
   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="tomcatembeddedservletcontainerfactory-又是如何被声明的">TomcatEmbeddedServletContainerFactory 又是如何被声明的？</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@AutoConfigureOrder</span><span class="o">(</span><span class="nc">Ordered</span><span class="o">.</span><span class="na">HIGHEST_PRECEDENCE</span><span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="nd">@ConditionalOnWebApplication</span>
<span class="nd">@Import</span><span class="o">(</span><span class="nc">BeanPostProcessorsRegistrar</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">EmbeddedServletContainerAutoConfiguration</span> <span class="o">{</span>

   <span class="cm">/**
    * Nested configuration if Tomcat is being used.
    */</span>
   <span class="nd">@Configuration</span>
   <span class="nd">@ConditionalOnClass</span><span class="o">({</span> <span class="nc">Servlet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">Tomcat</span><span class="o">.</span><span class="na">class</span> <span class="o">})</span>
   <span class="nd">@ConditionalOnMissingBean</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="nc">EmbeddedServletContainerFactory</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">search</span> <span class="o">=</span> <span class="nc">SearchStrategy</span><span class="o">.</span><span class="na">CURRENT</span><span class="o">)</span>
   <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">EmbeddedTomcat</span> <span class="o">{</span>

      <span class="nd">@Bean</span>
      <span class="kd">public</span> <span class="nc">TomcatEmbeddedServletContainerFactory</span> <span class="nf">tomcatEmbeddedServletContainerFactory</span><span class="o">()</span> <span class="o">{</span>
         <span class="k">return</span> <span class="k">new</span> <span class="nf">TomcatEmbeddedServletContainerFactory</span><span class="o">();</span>
      <span class="o">}</span>

   <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>只要类路径下存在 Tomcat 类，以及在 web 环境下，就会触发 springboot 的自动配置。</p>

<h2 id="总结">总结</h2>

<p>存在 web.xml 配置的 java web 项目，servlet3.0 的 java web 项目，springboot 内嵌容器的 java web 项目加载 servlet，filter，listener 的流程都是有所差异的，理解清楚这其中的原来，其实并不容易，至少得搞懂 servlet3.0 的规范，springboot 内嵌容器的加载流程等等前置逻辑。</p>

<p>最后感谢下小马哥的点拨，在此之前误以为： TomcatStarter 既然继承了 ServletContainerInitializer，应该也是符合 servlet3.0 规范的，但实际上并没有被 SPI 加载。</p>

<h2 id="推荐阅读">推荐阅读</h2>

<p>JAVA拾遗–关于SPI机制 https://www.cnkirito.moe/spi/</p>



                <hr>
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/07/01/MachLearning-autodeployed-python/" data-toggle="tooltip" data-placement="top" title="python自动化部署">
                        上一篇<br>
                        <span>python自动化部署</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2018/09/03/spring-xsd/" data-toggle="tooltip" data-placement="top" title="Spring中的XML schema扩展机制">
                        下一篇<br>
                        <span>Spring中的XML schema扩展机制</span>
                        </a>
                    </li>
                    
                </ul>


                

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">目录</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <hr class="hidden-sm hidden-xs">
                    <h5><a href="/tags/">类别标签</a></h5>
                    <div class="tags">
        				
                            
                				<a href="/tags/#技术杂谈" title="技术杂谈" rel="3">
                                    技术杂谈
                                </a>
                            
        				
                            
                				<a href="/tags/#markdown" title="markdown" rel="3">
                                    markdown
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#OOA" title="OOA" rel="4">
                                    OOA
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#Oracle" title="Oracle" rel="4">
                                    Oracle
                                </a>
                            
        				
                            
                				<a href="/tags/#数据库" title="数据库" rel="4">
                                    数据库
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#IDE" title="IDE" rel="7">
                                    IDE
                                </a>
                            
        				
                            
                				<a href="/tags/#DeskTop dev" title="DeskTop dev" rel="4">
                                    DeskTop dev
                                </a>
                            
        				
                            
                				<a href="/tags/#nw.js" title="nw.js" rel="3">
                                    nw.js
                                </a>
                            
        				
                            
                				<a href="/tags/#Linux" title="Linux" rel="20">
                                    Linux
                                </a>
                            
        				
                            
                				<a href="/tags/#IOS" title="IOS" rel="3">
                                    IOS
                                </a>
                            
        				
                            
                				<a href="/tags/#OpenSource" title="OpenSource" rel="7">
                                    OpenSource
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#Docker" title="Docker" rel="10">
                                    Docker
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
        				
                            
                				<a href="/tags/#机器学习" title="机器学习" rel="4">
                                    机器学习
                                </a>
                            
        				
                            
                				<a href="/tags/#自动化部署" title="自动化部署" rel="4">
                                    自动化部署
                                </a>
                            
        				
                            
                				<a href="/tags/#Spring" title="Spring" rel="3">
                                    Spring
                                </a>
                            
        				
                            
        				
                            
        				
                            
        				
        			</div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>友情连接</h5>
                <ul class="list-inline">
                    
                        <li><a href="http://geoserver.org/">GeoServer | 开源地图渲染</a></li>
                    
                        <li><a href="http://kafka.apache.org">kafaka |分布式流式平台</a></li>
                    
                        <li><a href="http://kafka.apache.org">activemq | 高可用的消息平台</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>






<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "xasa2q";
    var disqus_identifier = "/2018/08/14/spring-servlet-explore";
    var disqus_url = "http://localhost:4000/2018/08/14/spring-servlet-explore/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>



<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            display:none;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>


    <!-- Footer -->
<footer style="display: none;">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    

                    <!-- add Weibo, Zhihu by Hux, add target = "_blank" to <a> by Hux -->
                    
                    


                    
                    
                    <li>
                        <a target="_blank" href="https://github.com/caozhilong">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 思考生活 2020
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>



<!-- 三个按钮   Start-->
<style>
	.share {
	    border-top: 1px solid #E7E7E7;
	    border-bottom: 1px solid #E7E7E7;
	    margin-top: 20px;
	    padding: 20px;
	    text-align: center;
	    width: 100%;
	}
</style>
<div class="share">
	<div class="bshare-custom icon-medium-plus">
		<a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
		<a title="分享到QQ空间" class="bshare-qzone"></a>
		<a title="分享到微信" class="bshare-weixin"></a>
		<a title="分享到米聊" class="bshare-miliao"></a>
		<a title="分享到新浪微博" class="bshare-sinaminiblog"></a>
		<a title="分享到人人网" class="bshare-renren"></a>
		<a title="分享到腾讯微博" class="bshare-qqmb"></a>
		<a title="分享到凤凰微博" class="bshare-ifengmb"></a>
		<a title="分享到网易微博" class="bshare-neteasemb"></a>
	</div>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/button.js#style=-1&amp;uuid=&amp;pophcol=1&amp;lang=zh"></script>
	<a class="bshareDiv" onclick="javascript:return false;"></a>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
</div>
<!-- 三个按钮   End-->


<!-- 加入search插件 Begin -->
<div class="cb-search-tool" style="position: fixed; top: 0px ; bottom: 0px; left: 0px; right:  0px;
      opacity: 0.95; background-color: #111111; z-index: 9999; display: none;">
    <input type="text" class="form-control cb-search-content" id="cb-search-content" style="position: fixed; top: 60px" placeholder="文章标题 日期 标签" >

    <div style="position: fixed; top: 16px; right: 16px;">
        <img src="/assets/img/search/cb-close.png"  id="cb-close-btn"/>
    </div>
</div>

<!--
<div style="position: fixed; right: 16px; bottom: 20px;">
    <img src="/assets/img/search/cb-search.png"  id="cb-search-btn"  title="双击ctrl试一下"/>
</div>
-->
<div style="position: fixed; right: 16px; bottom: 20px;" id="cb-search-btn">
    <svg class="icon" style="width: 2em;height:  2em;vertical-align: middle;fill: currentColor;overflow: hidden;" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1348"><path d="M933.602 831.47 721.175 617.262c-2.472-2.479-5.204-4.372-7.813-6.435 35.884-55.518 56.836-121.647 56.836-192.878 0-195.694-157.298-354.31-351.461-354.31-194.054 0-351.461 158.616-351.461 354.31 0 195.722 157.407 354.302 351.461 354.302 70.631 0 136.303-21.179 191.459-57.361 2.009 2.692 3.852 5.369 6.283 7.827l212.454 214.235c14.506 14.579 33.396 21.849 52.314 21.849 18.932 0 37.836-7.268 52.328-21.814C962.436 907.824 962.436 860.61 933.602 831.47M418.737 660.37c-132.562 0-240.468-108.767-240.468-242.421 0-133.634 107.907-242.428 240.468-242.428 132.561 0 240.467 108.794 240.467 242.428C659.204 551.602 551.298 660.37 418.737 660.37" p-id="1349"></path></svg>
</div>
<!-- 加入search插件 End -->







<!-- jQuery -->
<script src="/assets/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/assets/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/assets/js/hux-blog.min.js "></script>

<!-- search plugin -->
<link rel="stylesheet" href="/assets/css/search/cb-search.css ">
<script src="/assets/js/search/bootstrap3-typeahead.min.js "></script>
<script src="/assets/js/search/cb-search.js "></script>

<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

      - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
      - https://help.github.com/articles/creating-and-highlighting-code-blocks/
      - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->

    <script>
        async("https://cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="https://cdn.bootcss.com/highlight.js/9.2.0/styles/github.min.css" rel="stylesheet">



<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->




<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog (selector) {
        var P = $('div.post-container'),a,n,t,l,i,c;
        a = P.find('h1,h2,h3,h4,h5,h6');
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#"+$(this).prop('id');
            t = $(this).text();
            c = $('<a href="'+i+'" rel="nofollow">'+t+'</a>');
            l = $('<li class="'+n+'_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;    
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function(e){
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/assets/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
	
	async("/assets/js/mermaid.min.js", function () {
		document.querySelectorAll('.language-mermaid').forEach(node => {
			const newNode = node.cloneNode(true)
			newNode.removeAttribute('class')
			const hr = document.createElement('hr')
			node.parentNode.insertBefore(hr, node)
			node.parentNode.insertBefore(newNode, hr)
		})
		window.mermaid.init(undefined, document.querySelectorAll('.language-mermaid'))
    });
	
</script>

<!-- MathJax插件
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-AMS_HTML-full"></script>
-->
<script type="text/x-mathjax-config">
  //MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });

    MathJax.Hub.Config({
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
        inlineMath: [["$","$"],["\\(","\\)"]],
        displayMath: [ ['$$', '$$']],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      messageStyle: "none",
      "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
    });
</script>
<script>
    async("https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML",function(){
        //to do somethings
        document.querySelectorAll('.language-math').forEach(node => {
            const newNode = node.cloneNode(true)
            newNode.removeAttribute('class')
            const hr = document.createElement('hr')
            const div = document.createElement('div')
            const mathNodes = [];
            if( node != null && typeof  node.textContent == 'string'){
                var mathLines = node.textContent.split("\n");
                for(var line in mathLines){
                    if(!/^s+$/.test(mathLines[line]) && "" != mathLines[line]){
                        mathNodes.push(mathLines[line]);
                    }
                }
            }
        const scriptEl = document.createElement('script')
        scriptEl.type="math/tex; mode=display";
scriptEl.textContent = "% <![CDATA[\n" +
    "\\begin{gather*} "+  mathNodes.join("\\\\\n") + "\\end{gather*}"
    +"%]]>";
        node.parentNode.insertBefore(scriptEl, node);
        node.hidden=true;
        });
    })

</script>





<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
